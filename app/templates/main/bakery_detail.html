{% extends 'base.html' %}

{% block title %}{{ bakery.name }}{% endblock %}

{% block content %}
<!-- Bakery Header -->
<section class="bakery-header">
    <div class="bakery-banner"
        style="background-image: url('{{ url_for('static', filename='images/' ~ (bakery.banner_url or 'default-bakery.png')) }}')">
        <div class="bakery-banner-overlay"></div>
    </div>
    <div class="container">
        <div class="bakery-profile">
            <div class="bakery-logo">
                <img src="{{ url_for('static', filename='images/' ~ bakery.logo_url) }}" alt="{{ bakery.name }}"
                    onerror="this.src='{{ url_for('static', filename='images/default-bakery.png') }}'">
            </div>
            <div class="bakery-details">
                <div class="bakery-title">
                    <h1>{{ bakery.name }}</h1>
                    {% if bakery.is_featured %}
                    <span class="badge badge-featured"><i class="fas fa-crown"></i> Featured</span>
                    {% endif %}
                    <span class="badge {% if bakery.is_open %}badge-open{% else %}badge-closed{% endif %}">
                        {{ 'Open' if bakery.is_open else 'Closed' }}
                    </span>
                </div>
                <p class="bakery-description">{{ bakery.description }}</p>
                <div class="bakery-stats">
                    <div class="stat">
                        <i class="fas fa-star"></i>
                        <span>{{ '%.1f'|format(bakery.rating) }} ({{ bakery.total_reviews }} reviews)</span>
                    </div>
                    <div class="stat">
                        <i class="fas fa-clock"></i>
                        <span>{{ bakery.delivery_time_mins }} mins</span>
                    </div>
                    <div class="stat">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>{{ bakery.city }}</span>
                    </div>
                    {% if bakery.min_order_amount > 0 %}
                    <div class="stat">
                        <i class="fas fa-shopping-bag"></i>
                        <span>Min. ₹{{ '%.0f'|format(bakery.min_order_amount) }}</span>
                    </div>
                    {% endif %}
                    {% if bakery.delivery_fee > 0 %}
                    <div class="stat">
                        <i class="fas fa-truck"></i>
                        <span>Delivery ₹{{ '%.0f'|format(bakery.delivery_fee) }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Menu Section -->
<section class="section bakery-menu">
    <div class="container">
        <div class="menu-layout">
            <!-- Categories Sidebar -->
            <aside class="menu-sidebar">
                <h3>Menu</h3>
                <nav class="category-nav">
                    <a href="#all-items" class="active">All Items</a>
                    {% for category in categories %}
                    <a href="#category-{{ category.id }}">{{ category.name }}</a>
                    {% endfor %}
                    {% if uncategorized_products %}
                    <a href="#category-other">Other</a>
                    {% endif %}
                </nav>
            </aside>

            <!-- Products -->
            <div class="menu-content">
                {% for category in categories %}
                {% if category.products.filter_by(is_available=True).count() > 0 %}
                <div class="menu-section" id="category-{{ category.id }}">
                    <h2>{{ category.name }}</h2>
                    <div class="product-list">
                        {% for product in category.products.filter_by(is_available=True).all() %}
                        <div class="product-card-horizontal">
                            <div class="product-image">
                                <img src="{{ url_for('static', filename='images/' ~ product.image_url) }}"
                                    alt="{{ product.name }}"
                                    onerror="this.src='{{ url_for('static', filename='images/default-product.png') }}'">
                                {% if product.is_bestseller %}
                                <span class="badge badge-bestseller"><i class="fas fa-fire"></i></span>
                                {% endif %}
                                {% if product.is_vegetarian %}
                                <span class="veg-badge"><i class="fas fa-leaf"></i></span>
                                {% endif %}
                            </div>
                            <div class="product-info">
                                <h4>{{ product.name }}</h4>
                                <p>{{ product.description[:100] if product.description else '' }}{% if
                                    product.description and product.description|length > 100 %}...{% endif %}</p>
                                <div class="product-footer">
                                    <div class="product-price">
                                        {% if product.discount_price %}
                                        <span class="price-old">₹{{ '%.0f'|format(product.price) }}</span>
                                        {% endif %}
                                        <span class="price-current">₹{{ '%.0f'|format(product.current_price) }}</span>
                                    </div>
                                    {% if product.stock_quantity > 0 and bakery.is_open %}
                                    <form action="{{ url_for('cart.add_to_cart') }}" method="POST"
                                        class="add-to-cart-form">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="product_id" value="{{ product.id }}">
                                        <input type="hidden" name="quantity" value="1">
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </form>
                                    {% else %}
                                    <span class="badge badge-unavailable">Unavailable</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}

                {% if uncategorized_products %}
                <div class="menu-section" id="category-other">
                    <h2>Other Items</h2>
                    <div class="product-list">
                        {% for product in uncategorized_products %}
                        <div class="product-card-horizontal">
                            <div class="product-image">
                                <img src="{{ url_for('static', filename='images/' ~ product.image_url) }}"
                                    alt="{{ product.name }}"
                                    onerror="this.src='{{ url_for('static', filename='images/default-product.png') }}'">
                            </div>
                            <div class="product-info">
                                <h4>{{ product.name }}</h4>
                                <p>{{ product.description[:100] if product.description else '' }}</p>
                                <div class="product-footer">
                                    <div class="product-price">
                                        <span class="price-current">₹{{ '%.0f'|format(product.current_price) }}</span>
                                    </div>
                                    {% if product.stock_quantity > 0 and bakery.is_open %}
                                    <form action="{{ url_for('cart.add_to_cart') }}" method="POST"
                                        class="add-to-cart-form">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="product_id" value="{{ product.id }}">
                                        <input type="hidden" name="quantity" value="1">
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Reviews Section -->
{% if reviews %}
<section class="section bakery-reviews">
    <div class="container">
        <h2><i class="fas fa-star"></i> Customer Reviews</h2>
        <div class="reviews-list">
            {% for review in reviews %}
            <div class="review-card">
                <div class="review-header">
                    <div class="review-user">
                        <div class="user-avatar">{{ review.user.name[0] }}</div>
                        <div>
                            <span class="user-name">{{ review.user.name }}</span>
                            <span class="review-date">{{ review.created_at.strftime('%b %d, %Y') }}</span>
                        </div>
                    </div>
                    <div class="review-rating">
                        {% for i in range(5) %}
                        <i class="fas fa-star {% if i < review.rating %}filled{% endif %}"></i>
                        {% endfor %}
                    </div>
                </div>
                {% if review.comment %}
                <p class="review-comment">{{ review.comment }}</p>
                {% endif %}
                {% if review.reply %}
                <div class="review-reply">
                    <strong><i class="fas fa-reply"></i> Bakery Response:</strong>
                    <p>{{ review.reply }}</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}
{% endblock %}