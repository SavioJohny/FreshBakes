{% extends 'base.html' %}

{% block title %}Checkout{% endblock %}

{% block content %}
<section class="page-header">
    <div class="container">
        <h1><i class="fas fa-credit-card"></i> Checkout</h1>
    </div>
</section>

<section class="section">
    <div class="container">
        <form method="POST" class="checkout-layout">
<div class="checkout-main">
                <!-- Delivery Address -->
                <div class="checkout-section">
                    <h3><i class="fas fa-map-marker-alt"></i> Delivery Address</h3>
                    {% if addresses %}
                    <div class="address-list">
                        {% for address in addresses %}
                        <label class="address-card {% if address.is_default %}selected{% endif %}">
                            <input type="radio" name="address_id" value="{{ address.id }}" {% if address.is_default
                                %}checked{% endif %} required>
                            <div class="address-content">
                                <span class="address-label">{{ address.label }}</span>
                                <p>{{ address.full_address }}</p>
                                <p>{{ address.city }} - {{ address.pincode }}</p>
                                {% if address.landmark %}
                                <p class="address-landmark">Landmark: {{ address.landmark }}</p>
                                {% endif %}
                            </div>
                            <i class="fas fa-check-circle"></i>
                        </label>
                        {% endfor %}
                    </div>
                    <a href="{{ url_for('add_address') }}?next={{ url_for('checkout') }}"
                        class="btn btn-secondary btn-sm">
                        <i class="fas fa-plus"></i> Add New Address
                    </a>
                    {% else %}
                    <div class="no-address">
                        <p>No delivery addresses found. Please add one to continue.</p>
                        <a href="{{ url_for('add_address') }}?next={{ url_for('checkout') }}"
                            class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Address
                        </a>
                    </div>
                    {% endif %}
                </div>

                <!-- Payment Method -->
                <div class="checkout-section">
                    <h3><i class="fas fa-wallet"></i> Payment Method</h3>
                    <div class="payment-options">
                        <label class="payment-option selected">
                            <input type="radio" name="payment_method" value="cod" checked>
                            <div class="payment-content">
                                <i class="fas fa-money-bill-wave"></i>
                                <span>Cash on Delivery</span>
                            </div>
                        </label>

                    </div>
                </div>

                <!-- Coupon -->
                <div class="checkout-section">
                    <h3><i class="fas fa-tag"></i> Apply Coupon</h3>
                    <div class="coupon-input">
                        <input type="text" name="coupon_code" placeholder="Enter coupon code" class="form-control">
                        <button type="button" class="btn btn-secondary" onclick="validateCoupon()">Apply</button>
                    </div>
                    <div id="couponMessage"></div>
                </div>

                <!-- Special Instructions -->
                <div class="checkout-section">
                    <h3><i class="fas fa-sticky-note"></i> Special Instructions</h3>
                    <textarea name="special_instructions" class="form-control" rows="3"
                        placeholder="Any special requests for your order..."></textarea>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="checkout-sidebar">
                <div class="summary-card">
                    <h3>Order Summary</h3>
                    <div class="summary-bakery">
                        <span><i class="fas fa-store"></i> {{ bakery.name }}</span>
                    </div>

                    <div class="summary-items">
                        {% for item in cart_items %}
                        <div class="summary-item">
                            <span>{{ item.product.name }} × {{ item.quantity }}</span>
                            <span>₹{{ '%.0f'|format(item.subtotal) }}</span>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="summary-divider"></div>

                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span>₹{{ '%.0f'|format(subtotal) }}</span>
                    </div>
                    <div class="summary-row">
                        <span>Delivery Fee</span>
                        <span>₹{{ '%.0f'|format(delivery_fee) }}</span>
                    </div>
                    <div class="summary-row discount" id="discountRow" style="display: none;">
                        <span>Discount</span>
                        <span id="discountAmount">-₹0</span>
                    </div>

                    <div class="summary-divider"></div>

                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="totalAmount">₹{{ '%.0f'|format(subtotal + delivery_fee) }}</span>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block btn-lg" {% if not addresses %}disabled{%
                        endif %}>
                        <i class="fas fa-check"></i> Place Order
                    </button>

                    <p class="summary-note">
                        <i class="fas fa-clock"></i> Estimated delivery: {{ bakery.delivery_time_mins }} mins
                    </p>
                </div>
            </div>
        </form>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    const subtotal = {{ subtotal }};
    const deliveryFee = {{ delivery_fee }};
    let discount = 0;

    async function validateCoupon() {
        const code = document.querySelector('[name="coupon_code"]').value;
        const messageEl = document.getElementById('couponMessage');

        if (!code) {
            messageEl.innerHTML = '<span class="text-danger">Please enter a coupon code</span>';
            return;
        }

        try {
            const response = await fetch('/api/coupon/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    },
                body: JSON.stringify({
                    code: code,
                    order_amount: subtotal,
                    bakery_id: {{ bakery.id }}
            })
    });

    const data = await response.json();

    if (data.valid) {
        discount = data.discount;
        document.getElementById('discountRow').style.display = 'flex';
        document.getElementById('discountAmount').textContent = '-₹' + discount.toFixed(0);
        document.getElementById('totalAmount').textContent = '₹' + (subtotal + deliveryFee - discount).toFixed(0);
        messageEl.innerHTML = '<span class="text-success"><i class="fas fa-check"></i> ' + data.message + '</span>';
    } else {
        discount = 0;
        document.getElementById('discountRow').style.display = 'none';
        document.getElementById('totalAmount').textContent = '₹' + (subtotal + deliveryFee).toFixed(0);
        messageEl.innerHTML = '<span class="text-danger"><i class="fas fa-times"></i> ' + data.message + '</span>';
    }
    } catch (error) {
        messageEl.innerHTML = '<span class="text-danger">Error validating coupon</span>';
    }
}
</script>
{% endblock %}